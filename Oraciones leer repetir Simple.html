<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√°ctica de Oraciones en Espa√±ol (Nivel Primaria)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥n de fuente y estilos generales */
        :root {
            --success: #34D399; /* green-400 */
            --warning: #FBBF24; /* amber-400 */
            --error: #F87171; /* red-400 */
            --bg-light: #F9FAFB; /* gray-50 */
            --primary-text: #1F2937; /* gray-800 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--primary-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .card {
            background-color: white;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 3rem 2rem;
            max-width: 900px;
            width: 100%;
            border: 1px solid #E5E7EB; /* gray-200 */
        }

        /* Estilo para el bot√≥n principal (Escuchar/Repetir) */
        .main-button {
            transition: all 0.2s;
            transform-origin: center;
        }

        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pulse-animation {
            animation: pulse-ring 1s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Iconos de feedback - Muestra el √≠cono encima de la frase */
        .feedback-icon {
            transition: opacity 0.3s;
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* Clase para ocultar el feedback con opacidad */
        .feedback-hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* Estilo para el bot√≥n de Omitir (Amarillo/√Åmbar) */
        #skip-button {
            background-color: #F59E0B; /* amber-500 */
            color: white;
        }
        #skip-button:hover {
            background-color: #D97706; /* amber-700 */
        }
        
        /* ESTILO PARA LA LECTURA EN VOZ ALTA (SUBRAYADO ROJO GRUESO) */
        .highlight-word {
            display: inline-block; /* Esencial para que el borde se muestre correctamente en elementos inline */
            padding-bottom: 2px;
            border-bottom: 4px solid #EF4444; /* red-500 */
            transition: border-bottom 0.1s ease-out;
            border-radius: 2px;
        }
        
        /* Estilos del Panel de Diagn√≥stico */
        .debug-panel {
            background-color: #fef3c7; /* amber-100 */
            border: 1px dashed #f59e0b; /* amber-500 */
        }
    </style>
    <script>
        // Configuraci√≥n de Tailwind para usar la fuente Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body>

<div id="app" class="card">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-800">Pr√°ctica de Voz en Espa√±ol</h1>
    <p class="text-center text-gray-500 mb-8 font-semibold text-red-600">
        ¬°MODO ESTRICTO! **Conteo exacto de palabras** y precisi√≥n fon√©tica ajustada al **35%** (Tolerancia m√°xima para iOS/Safari).
    </p>

    <!-- Marcador y Estad√≠sticas -->
    <div class="flex justify-between items-center mb-10">
        <!-- Correctas -->
        <div id="correctas-box" class="flex-1 bg-green-100 p-4 rounded-xl shadow-md border-2 border-green-300 mr-2">
            <p class="text-sm font-semibold text-green-700">Correctas:</p>
            <p id="correctas-count" class="text-2xl font-bold text-green-800">0 correctas de 0</p>
        </div>

        <!-- Omitidas (Skip) -->
        <div id="skip-box" class="flex-1 bg-amber-100 p-4 rounded-xl shadow-md border-2 border-amber-300 mx-2">
            <p class="text-sm font-semibold text-amber-700">Omitidas:</p>
            <p id="skip-count" class="text-2xl font-bold text-amber-800">0</p>
        </div>

        <!-- Errores -->
        <div id="errores-box" class="flex-1 bg-red-100 p-4 rounded-xl shadow-md border-2 border-red-300 ml-2">
            <p class="text-sm font-semibold text-red-700">Errores al Repetir:</p>
            <p id="errores-count" class="text-2xl font-bold text-red-800">0</p>
        </div>
    </div>

    <!-- Contenedor Principal de la Oraci√≥n y Feedback -->
    <div class="text-center mb-12 min-h-[180px] flex flex-col justify-center items-center relative">
        <h2 id="current-sentence" class="text-4xl sm:text-5xl font-extrabold text-gray-800 transition duration-300 min-h-20">
            <!-- La oraci√≥n se inserta aqu√≠ -->
        </h2>
        
        <!-- Iconos de Feedback (Check Verde / Cruz Roja) -->
        <div id="feedback-container" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <!-- Check Verde (Triunfo) -->
            <svg id="check-icon" class="feedback-icon text-green-500 w-36 h-36 drop-shadow-2xl feedback-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <!-- Cruz Roja (Falla) -->
            <svg id="cross-icon" class="feedback-icon text-red-500 w-36 h-36 drop-shadow-2xl feedback-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        </div>

        <!-- Contador de Intentos -->
        <p id="attempts-message" class="mt-4 text-lg font-medium text-gray-500 transition-opacity duration-300 opacity-0">Intentos restantes: 3</p>
    </div>

    <!-- Controles -->
    <div class="flex flex-col items-center space-y-4">
        <!-- Bot√≥n de ESCUCHAR/REPETIR -->
        <button id="main-action-button" onclick="handleMainAction()" class="main-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg w-full sm:w-80 flex items-center justify-center space-x-2">
            <!-- Icono de altavoz -->
            <svg id="listen-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M12.5 10.5V11m2 0h.5M4.5 10.5V11m-2 0h.5m16.5 0h.5m-20.5 0h.5m10-2.25h.5m-2 0h.5m-8.5-6.75h.5m-2 0h.5m16.5 0h.5m-20.5 0h.5m10 12h.5m-2 0h.5m-8.5 6.75h.5m-2 0h.5m16.5 0h.5m-20.5 0h.5M10.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
            </svg>
            <!-- Icono de micr√≥fono -->
            <svg id="repeat-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3M15 12.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
            <span id="button-text">Escuchar Oraci√≥n</span>
        </button>

        <!-- Bot√≥n de OMITIR (Skip) - Color AMARILLO solicitado -->
        <button id="skip-button" onclick="skipSentence()" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 px-6 rounded-full text-sm shadow hidden transition duration-150">
            Omitir y Pasar a la Siguiente
        </button>

        <!-- Mensaje de Estado -->
        <p id="status-message" class="text-lg text-gray-600 h-6">Listo.</p>
    </div>
    
    <!-- PANEL DE DIAGN√ìSTICO (Visible temporalmente) -->
    <div id="debug-panel" class="debug-panel p-4 mt-8 rounded-xl space-y-2 transition-all duration-300">
        <h3 class="text-lg font-bold text-amber-800 cursor-pointer flex justify-between items-center" onclick="toggleDebugPanel()">
            üõ†Ô∏è Panel de Diagn√≥stico (Haz clic para ocultar)
            <svg id="debug-toggle-icon" class="w-5 h-5 transform rotate-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
            </svg>
        </h3>
        <div id="debug-content" class="text-sm text-amber-900 border-t border-amber-500 pt-2">
            <p class="font-semibold">Esperando intento de voz...</p>
            <p id="debug-expected" class="mt-1">** ESPERADO (Normalizado): **</p>
            <p id="debug-transcript">** DETECTADO (Normalizado): **</p>
            <p id="debug-distance" class="mt-2">** RESULTADO LEVENSHTEIN: ** Distancia (Error Fon√©tico) / Tolerancia (35%)</p>
            <p id="debug-words" class="mt-2">** CONTEO DE PALABRAS: **</p>
        </div>
    </div>
    <!-- FIN DEL PANEL DE DIAGN√ìSTICO -->
</div>

<script>
    // Estado global de la aplicaci√≥n
    let appState = {
        sentences: [],
        currentSentenceIndex: 0,
        attemptsLeft: 3,
        totalCorrect: 0,
        totalSkipped: 0,
        totalErrors: 0,
        totalRead: 0, 
        isListening: false,
        isReading: false,
        isCheckPerformed: false,
        wordSpans: [], // Almacena los elementos <span> de las palabras
        spanishVoice: null, // Cache para la voz en espa√±ol (optimizaci√≥n para iOS)
        isDebugPanelVisible: true, // Nuevo estado para el panel
    };
    // Almacena los √≠ndices de inicio de cada palabra en la cadena original para la sincronizaci√≥n TTS
    let wordStartIndices = []; 

    // --- L√≥gica del Juego ---
    // AJUSTE CR√çTICO: Tolerancia aumentada a 35% (0.35) para la m√°xima fiabilidad en Safari/iOS.
    const TOLERANCE_PERCENTAGE = 0.35; 
    // AJUSTE SOLICITADO: Debe coincidir el conteo exacto de palabras (REGLA DEL USUARIO).
    const STRICT_WORD_COUNT_CHECK = true;

    // --- Referencias DOM ---
    const sentenceEl = document.getElementById('current-sentence');
    const mainButton = document.getElementById('main-action-button');
    const buttonText = document.getElementById('button-text');
    const listenIcon = document.getElementById('listen-icon');
    const repeatIcon = document.getElementById('repeat-icon');
    const skipButton = document.getElementById('skip-button');
    const statusMessage = document.getElementById('status-message');
    const attemptsMessage = document.getElementById('attempts-message');
    const checkIcon = document.getElementById('check-icon');
    const crossIcon = document.getElementById('cross-icon');
    const correctasCountEl = document.getElementById('correctas-count');
    const skipCountEl = document.getElementById('skip-count');
    const erroresCountEl = document.getElementById('errores-count');
    
    // Referencias al Panel de Diagn√≥stico
    const debugContentEl = document.getElementById('debug-content');
    const debugExpectedEl = document.getElementById('debug-expected');
    const debugTranscriptEl = document.getElementById('debug-transcript');
    const debugDistanceEl = document.getElementById('debug-distance');
    const debugWordsEl = document.getElementById('debug-words');
    const debugToggleIconEl = document.getElementById('debug-toggle-icon');

    // --- Base de Datos de Oraciones (Con puntuaci√≥n y signos) ---
    const ALL_SENTENCES = [
        "¬°El sol brilla hoy!",
        "Yo tengo un perro.",
        "¬øMi mam√° lee un libro?",
        "¬°Qu√© hermoso d√≠a!",
        "Mira el p√°jaro.",
        "Dame la mano, por favor.",
        "El carro es rojo.",
        "La casa es grande y bonita.",
        "¬°Amo a mi familia!",
        "El gato duerme en la silla.",
        "Juega con la pelota.",
        "¬øVas al colegio hoy?",
        "Hoy es mi d√≠a de suerte.",
        "Pon la mesa.",
        "¬øD√≥nde est√° pap√°?",
        "Qu√©date en casa.",
        "¬°Tengo mucha hambre!",
        "Vamos al parque.",
        "El agua est√° fr√≠a.",
        "Canta una canci√≥n alegre.",
        "Mi nombre es Juan.",
        "Come tu fruta.",
        "L√°vate los dientes.",
        "Me gusta nadar.",
        "Es hora de dormir."
    ];
    
    // --- FUNCI√ìN: Normaliza texto (quita acentos y puntuaci√≥n) ---
    function normalizeText(text) {
        // 1. Quitar puntuaci√≥n y signos de interrogaci√≥n/exclamaci√≥n. Se mantiene el espacio entre palabras.
        let cleaned = text.trim().toLowerCase().replace(/[.,!?;:¬ø¬°]/g, '').replace(/\s+/g, ' ');
        
        // 2. Quitar diacr√≠ticos (acentos) - CRUCIAL para el reconocimiento de voz
        cleaned = cleaned.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        return cleaned;
    }

    // --- Algoritmo de Levenshtein (Para mayor sensibilidad de voz) ---
    function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
        for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                const cost = (b.charAt(i - 1) === a.charAt(j - 1) || (b.charAt(i - 1) === 'r' && a.charAt(j - 1) === 'l')) ? 0 : 1;
                matrix[i][j] = Math.min(
                    matrix[i - 1][j] + 1,       // Eliminaci√≥n
                    matrix[i][j - 1] + 1,       // Inserci√≥n
                    matrix[i - 1][j - 1] + cost // Sustituci√≥n
                );
            }
        }
        return matrix[b.length][a.length];
    }

    // --- Audio Feedback (Generador de sonidos simples) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioContext ? new AudioContext() : null;

    function playSound(frequency, duration, volume, type) {
        if (!audioCtx) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = type; 
        oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);

        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + duration);
    }

    function playSuccessSound() {
        playSound(660, 0.15, 0.5, 'triangle');
        setTimeout(() => playSound(880, 0.15, 0.5, 'triangle'), 150);
    }

    function playFailureSound() {
        playSound(220, 0.3, 0.5, 'square');
    }

    // --- L√≥gica del Juego ---

    function toggleDebugPanel() {
        appState.isDebugPanelVisible = !appState.isDebugPanelVisible;
        debugContentEl.classList.toggle('hidden', !appState.isDebugPanelVisible);
        if (appState.isDebugPanelVisible) {
            debugToggleIconEl.classList.remove('rotate-180');
        } else {
            debugToggleIconEl.classList.add('rotate-180');
        }
    }

    function updateScoreDisplay() {
        appState.totalRead = appState.totalCorrect + appState.totalSkipped + appState.totalErrors;
        correctasCountEl.textContent = `${appState.totalCorrect} correctas de ${appState.totalRead}`;
        skipCountEl.textContent = appState.totalSkipped;
        erroresCountEl.textContent = appState.totalErrors;
    }

    function loadNewSentence() {
        // Recargar y mezclar las oraciones si se llega al final
        if (appState.sentences.length === 0 || appState.currentSentenceIndex >= ALL_SENTENCES.length) {
            // Mezclar solo si se terminaron o es la primera carga
            if (appState.sentences.length === 0 || appState.currentSentenceIndex === ALL_SENTENCES.length) {
                appState.sentences = [...ALL_SENTENCES].sort(() => 0.5 - Math.random());
            }
            appState.currentSentenceIndex = 0;
        }

        const sentence = appState.sentences[appState.currentSentenceIndex];
        
        // 1. Limpiar el contenedor y las referencias del estado
        sentenceEl.innerHTML = '';
        appState.wordSpans = [];
        wordStartIndices = [];
        
        // 2. Crear los <span> para la sincronizaci√≥n visual
        const words = sentence.match(/\S+/g) || []; 
        let currentIndex = 0;

        words.forEach((word, index) => {
            // Intentar encontrar el √≠ndice de inicio de la palabra en la oraci√≥n original
            const originalIndex = sentence.indexOf(word, currentIndex);
            if (originalIndex !== -1) {
                 currentIndex = originalIndex;
            }
            wordStartIndices.push(currentIndex);

            const span = document.createElement('span');
            span.textContent = word;
            span.id = `word-${index}`;
            // Clase base sin el subrayado
            span.className = 'transition duration-100 ease-out'; 
            
            // Agregar el span al elemento H2
            sentenceEl.appendChild(span);
            appState.wordSpans.push(span);

            // Agregar un espacio como TextNode si no es la √∫ltima palabra
            if (index < words.length - 1) {
                sentenceEl.appendChild(document.createTextNode(' '));
                currentIndex += word.length + 1; // Ajuste del √≠ndice (palabra + espacio)
            } else {
                currentIndex += word.length; // √öltima palabra
            }
        });
        
        appState.attemptsLeft = 3; 
        appState.isCheckPerformed = false; 
        
        // Resetear UI
        attemptsMessage.textContent = `Intentos restantes: 3`;
        attemptsMessage.classList.add('opacity-0');
        skipButton.classList.add('hidden'); 
        
        setMainButtonState('listen'); 
        statusMessage.textContent = 'Listo.';
        
        // Limpiar panel de diagn√≥stico
        debugExpectedEl.textContent = `** ESPERADO (Normalizado): **`;
        debugTranscriptEl.textContent = `** DETECTADO (Normalizado): **`;
        debugDistanceEl.textContent = `** RESULTADO LEVENSHTEIN: ** Distancia (Error Fon√©tico) / Tolerancia (35%)`;
        debugWordsEl.textContent = `** CONTEO DE PALABRAS: **`;
    }

    async function handleMainAction() {
        if (appState.isReading || appState.isListening) return;

        if (mainButton.dataset.action === 'listen') {
            readSentence();
        } else if (mainButton.dataset.action === 'repeat') {
            startListening();
        }
    }

    function setMainButtonState(state) {
        window.speechSynthesis.cancel(); 
        
        // Remover todas las clases de color y animaci√≥n
        mainButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'pulse-animation', 'bg-amber-500', 'hover:bg-amber-600', 'bg-gray-400');

        mainButton.dataset.action = state;
        if (state === 'listen') {
            // Estado Inicial: Escuchar Oraci√≥n (Oreja)
            buttonText.textContent = 'üëÇ Escuchar Oraci√≥n';
            listenIcon.classList.remove('hidden'); 
            repeatIcon.classList.add('hidden');
            // Bot√≥n por defecto (Azul)
            mainButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else if (state === 'repeat') {
            // Estado Listo para Repetir (Dedo/Oprimir)
            buttonText.textContent = 'üëÜ Repetir Ahora'; 
            listenIcon.classList.add('hidden');
            repeatIcon.classList.remove('hidden'); // Mostrar icono de micr√≥fono
            // Cambiado a color AZUL (Blue) para evitar confusi√≥n con el bot√≥n de Skip
            mainButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else if (state === 'reading') {
            // Estado Leyendo (Altavoz)
            buttonText.textContent = 'Leyendo...';
            listenIcon.classList.remove('hidden'); // Mostrar icono de altavoz
            repeatIcon.classList.add('hidden');
            // Se mantiene el azul para indicar que est√° procesando
            mainButton.classList.add('bg-blue-600', 'pulse-animation');
        } else if (state === 'listening') {
            // Estado Escucha Activa (Boca hablando)
            buttonText.textContent = 'üó£Ô∏è Escuchando... ¬°Habla ahora!';
            listenIcon.classList.add('hidden');
            repeatIcon.classList.remove('hidden'); // Mostrar icono de micr√≥fono
            // Usamos verde para indicar escucha activa.
            mainButton.classList.add('bg-green-600', 'pulse-animation');
        }
    }

    // --- L√≥gica de Texto a Voz (TTS) Nativa del Navegador ---
    function readSentence() {
        window.speechSynthesis.cancel();
        
        appState.isReading = true;
        setMainButtonState('reading');

        const sentence = appState.sentences[appState.currentSentenceIndex];
        const utterance = new SpeechSynthesisUtterance(sentence);
        
        // Usar la voz cacheada si est√° disponible
        if (appState.spanishVoice) {
            utterance.voice = appState.spanishVoice;
            utterance.lang = appState.spanishVoice.lang;
        } else {
            // Fallback si no se encontr√≥ o carg√≥ la voz
            utterance.lang = 'es-ES';
        }
        
        // Ajuste de velocidad (rate) a 0.9 para una voz menos rob√≥tica
        utterance.rate = 0.9; 

        utterance.onstart = () => {
            statusMessage.textContent = '¬°Escucha con atenci√≥n!';
            // Limpiar resaltados al inicio
            appState.wordSpans.forEach(span => span.classList.remove('highlight-word'));
        };

        // L√ìGICA PARA EL SUBRAYADO PALABRA POR PALABRA
        utterance.onboundary = (event) => {
            if (event.name === 'word') {
                const charIndex = event.charIndex;
                
                let wordIndex = -1;
                for (let i = 0; i < wordStartIndices.length; i++) {
                    // Si el √≠ndice del car√°cter est√° dentro de esta palabra
                    if (charIndex >= wordStartIndices[i] && (i + 1 === wordStartIndices.length || charIndex < wordStartIndices[i + 1])) {
                        wordIndex = i;
                        break;
                    }
                }

                if (wordIndex !== -1 && wordIndex < appState.wordSpans.length) {
                    appState.wordSpans.forEach(span => span.classList.remove('highlight-word'));
                    // APLICAR LA RAYA ROJA GRUESA:
                    appState.wordSpans[wordIndex].classList.add('highlight-word');
                }
            }
        };

        utterance.onend = () => {
            appState.isReading = false;
            setMainButtonState('repeat'); 
            statusMessage.textContent = 'Ahora, repite la oraci√≥n.';
            attemptsMessage.classList.remove('opacity-0');
            
            // Quitar el resaltado al finalizar la lectura
            appState.wordSpans.forEach(span => span.classList.remove('highlight-word'));
        };
        
        utterance.onerror = (event) => {
            console.error('SpeechSynthesis Utterance Error:', event);
            statusMessage.textContent = `Error al leer: ${event.error}. Intenta de nuevo.`;
            appState.isReading = false;
            setMainButtonState('listen');
            appState.wordSpans.forEach(span => span.classList.remove('highlight-word'));
        };

        window.speechSynthesis.speak(utterance);
    }

    // --- L√≥gica de Reconocimiento de Voz (STT) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let recognitionTimeout = null;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES'; 
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            appState.isListening = true;
            setMainButtonState('listening');
            appState.isCheckPerformed = false; // Resetear al inicio de la escucha
        };

        recognition.onresult = (event) => {
            clearTimeout(recognitionTimeout);
            
            if (appState.isCheckPerformed) return; 

            try { recognition.stop(); } catch (e) { console.error("Error al detener reconocimiento en onresult:", e); }

            // Tomamos la transcripci√≥n original (puede incluir puntuaci√≥n/capitales)
            const transcript = event.results[0][0].transcript;
            
            console.log('--- RECONOCIMIENTO DE VOZ ---');
            console.log('Transcripci√≥n recibida (Original):', transcript);
            
            appState.isCheckPerformed = true; 
            checkRepetition(transcript);
        };

        // L√ìGICA PARA EL MANEJO DE ERRORES
        recognition.onerror = (event) => {
            clearTimeout(recognitionTimeout);
            appState.isListening = false;
            
            if (appState.isCheckPerformed) return; 
            appState.isCheckPerformed = true;

            let errorMessage = `Error: ${event.error}. Aseg√∫rate de que el micr√≥fono est√© conectado y de que hayas dado permiso.`;
            
            // Detecci√≥n espec√≠fica de errores de permiso
            if (event.error === 'not-allowed' || event.error === 'permission-denied' || event.error === 'denied') {
                errorMessage = '¬°ERROR DE PERMISO! La aplicaci√≥n necesita acceso al micr√≥fono. Por favor, revisa la configuraci√≥n del navegador.';
            } else if (event.error === 'aborted') {
                errorMessage = 'El reconocimiento fue cancelado. Intenta de nuevo y habla inmediatamente.';
            } else if (event.error === 'no-speech') {
                errorMessage = 'No se detect√≥ voz. Aseg√∫rate de hablar claramente.';
            } else if (event.error === 'network') {
                errorMessage = 'Error de red. Revisa tu conexi√≥n a internet.';
            } else if (event.error === 'service-not-allowed') {
                errorMessage = 'El servicio de reconocimiento fue bloqueado por tu navegador o sistema.';
            }
            
            statusMessage.textContent = errorMessage;

            handleIncorrect(true); // Indica que es un error de sistema
            setMainButtonState('listen');
        };

        recognition.onend = () => {
            clearTimeout(recognitionTimeout);
            appState.isListening = false;
            
            if (!appState.isCheckPerformed) {
                appState.isCheckPerformed = true; 
                setMainButtonState('listen');
                statusMessage.textContent = 'Tiempo de escucha agotado. Vuelve a escuchar.';
                handleIncorrect(true); 
            }
        };

    } else {
        statusMessage.textContent = 'ERROR: Tu navegador no soporta Reconocimiento de Voz.';
        mainButton.disabled = true;
        setMainButtonState('listen');
        mainButton.classList.add('bg-gray-400', 'cursor-not-allowed');
    }

    function startListening() {
        if (!recognition || appState.isListening) return;
        
        try {
            window.speechSynthesis.cancel();
            recognition.start();
            statusMessage.textContent = 'Escuchando... ¬°Habla claramente!';
            // Timeout de 7 segundos para la escucha
            recognitionTimeout = setTimeout(() => {
                recognition.stop();
            }, 7000); 
        } catch (e) {
            console.error("Error al iniciar reconocimiento:", e);
            statusMessage.textContent = 'Error al iniciar la escucha. Recarga la p√°gina.';
        }
    }

    // --- Evaluaci√≥n con Umbral Ajustado (35%) y Conteo de Palabras ESTRICTO ---

    function checkRepetition(transcript) {
        const expectedSentence = appState.sentences[appState.currentSentenceIndex];
        
        // Funci√≥n auxiliar para contar palabras limpias
        const cleanForCount = (text) => text.trim().toLowerCase().replace(/[.,!?;:¬ø¬°]/g, '').split(/\s+/).filter(Boolean);
        const expectedWords = cleanForCount(expectedSentence);
        const transcriptWords = cleanForCount(transcript);
        
        // 1. EVALUACI√ìN FON√âTICA (Levenshtein al 35% para m√°xima tolerancia en iOS)
        const cleanedExpected = normalizeText(expectedSentence);
        const cleanedTranscript = normalizeText(transcript);
        
        const toleranceThreshold = Math.ceil(cleanedExpected.length * TOLERANCE_PERCENTAGE); 
        const distance = levenshteinDistance(cleanedExpected, cleanedTranscript);
        
        let isCorrect = false;
        let failureReason = null;

        // 2. CONTEO DE PALABRAS (Chequeo Estricto M√°ximo - Regla del Usuario)
        if (STRICT_WORD_COUNT_CHECK && expectedWords.length !== transcriptWords.length) {
            failureReason = `¬°Fallo Estricto! Debes repetir **exactamente** ${expectedWords.length} palabras. Tu dijiste ${transcriptWords.length}.`;
        } else if (distance > toleranceThreshold) {
            // Falla por distancia fon√©tica
            failureReason = `Error fon√©tico/de pronunciaci√≥n (Distancia: ${distance}). Vuelve a escuchar y repite.`;
        } else {
            // Pasa ambos checks
            isCorrect = true;
        }
        
        // ACTUALIZAR PANEL DE DIAGN√ìSTICO
        debugExpectedEl.textContent = `** ESPERADO (Normalizado): ** "${cleanedExpected}" (${expectedWords.length} palabras)`;
        debugTranscriptEl.textContent = `** DETECTADO (Normalizado): ** "${cleanedTranscript}" (${transcriptWords.length} palabras)`;
        debugDistanceEl.textContent = `** RESULTADO LEVENSHTEIN: ** Distancia: ${distance} / Tolerancia (35%): ${toleranceThreshold}. ${isCorrect ? '‚úÖ ¬°CORRECTO!' : '‚ùå FALL√ì.'}`;
        debugWordsEl.textContent = `** CONTEO DE PALABRAS: ** Esperado: ${expectedWords.length}. Detectado: ${transcriptWords.length}.`;


        if (isCorrect) {
            handleCorrect();
        } else {
            statusMessage.textContent = failureReason;
            handleIncorrect(false); 
        }
    }

    function handleCorrect() {
        // 1. Aumentar estad√≠sticas (solo si no se ha completado ya)
        appState.totalCorrect++;
        appState.totalRead++; 
        
        // 2. Feedback visual (Check Verde)
        showFeedback(checkIcon, playSuccessSound, 1500); 
        
        statusMessage.textContent = '¬°Correcto! ¬°Muy bien hecho! Pasando a la siguiente...';
        
        // 3. Pasa a la siguiente oraci√≥n despu√©s de 1.5 segundos
        setTimeout(() => {
            appState.currentSentenceIndex = (appState.currentSentenceIndex + 1) % ALL_SENTENCES.length;
            loadNewSentence();
            updateScoreDisplay();
        }, 1500);
    }

    function handleIncorrect(isSystemError) {
        
        if (!isSystemError || appState.attemptsLeft > 0) {
            // 1. Feedback visual (Cruz Roja)
            showFeedback(crossIcon, playFailureSound, 1500);
            
            // 2. Aumentar el contador de errores de estad√≠stica
            appState.totalErrors++; 

            if (!isSystemError) {
                // Error de transcripci√≥n: Penaliza intento
                appState.attemptsLeft--;
            }
        }
        
        // 3. Gestionar estado de intentos
        if (appState.attemptsLeft > 0) {
            // Quedan intentos
            attemptsMessage.textContent = `Intentos restantes: ${appState.attemptsLeft}`;
            attemptsMessage.classList.remove('opacity-0');
            setMainButtonState('listen'); // Permite al usuario escuchar de nuevo
        } else {
            // 3 intentos fallidos de transcripci√≥n (o sistema en el √∫ltimo intento)
            appState.totalRead++; // Se cuenta como le√≠da (fallida)

            statusMessage.textContent = '3 intentos fallidos. Puedes omitir o intentar de nuevo.';
            attemptsMessage.textContent = `Intentos restantes: 0 (Fallidos)`;
            attemptsMessage.classList.remove('opacity-0');
            
            // Mostrar el bot√≥n de SKIP (amarillo)
            skipButton.classList.remove('hidden'); 
            setMainButtonState('listen');
        }
        updateScoreDisplay();
    }
    
    function skipSentence() {
        // Asegura que el reconocimiento y la lectura se detengan
        window.speechSynthesis.cancel();
        if (recognition) {
            try { recognition.stop(); } catch (e) {}
        }
        clearTimeout(recognitionTimeout);

        // Si la oraci√≥n ya se cont√≥ como 'le√≠da' por fallar 3 veces, no la contamos de nuevo.
        if (appState.attemptsLeft === 3) {
             appState.totalRead++;
        }
        
        appState.totalSkipped++;
        statusMessage.textContent = 'Oraci√≥n omitida. ¬°Sigamos con la siguiente!';
        
        // Pasa a la siguiente oraci√≥n
        setTimeout(() => {
            appState.currentSentenceIndex = (appState.currentSentenceIndex + 1) % ALL_SENTENCES.length;
            loadNewSentence();
            updateScoreDisplay();
        }, 1000);
    }

    // Funci√≥n para mostrar el √≠cono de feedback
    function showFeedback(iconElement, soundFunction, duration = 1200) {
        checkIcon.classList.add('feedback-hidden');
        crossIcon.classList.add('feedback-hidden');
        
        iconElement.classList.remove('feedback-hidden');
        if (soundFunction) {
            soundFunction();
        }

        setTimeout(() => {
            iconElement.classList.add('feedback-hidden');
        }, duration);
    }
    
    // Funci√≥n para precargar y cachear la voz en espa√±ol
    function cacheSpanishVoice() {
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = cacheSpanishVoice;
            return;
        }

        const voices = window.speechSynthesis.getVoices();
        
        // Prioridad: Voces espec√≠ficas de alta calidad o nativas del sistema
        const preferredVoiceNames = ['Siri', 'Monica', 'Laura', 'Jorge', 'Juan', 'Paulina', 'Marisa', 'Google espa√±ol'];
        
        let bestSpanishVoice = null;

        for (const name of preferredVoiceNames) {
            bestSpanishVoice = voices.find(voice => 
                voice.name.includes(name) && voice.lang.startsWith('es')
            );
            if (bestSpanishVoice) {
                appState.spanishVoice = bestSpanishVoice;
                console.log(`TTS: Voz seleccionada (por nombre): ${bestSpanishVoice.name}`);
                return;
            }
        }

        // Fallback: Cualquier voz en espa√±ol (es-XX)
        if (!bestSpanishVoice) {
            bestSpanishVoice = voices.find(voice => voice.lang.startsWith('es'));
        }

        if (bestSpanishVoice) {
            appState.spanishVoice = bestSpanishVoice;
            if (!appState.spanishVoice.name.includes(preferredVoiceNames[0])) {
                console.log(`TTS: Voz seleccionada (gen√©rica): ${bestSpanishVoice.name} (${bestSpanishVoice.lang})`);
            }
        } else {
            console.warn('TTS: No se encontr√≥ ninguna voz en espa√±ol. Se utilizar√° el valor por defecto del navegador.');
        }
    }

    // --- Inicializaci√≥n ---
    window.onload = () => {
        loadNewSentence();
        updateScoreDisplay();
        
        // Ocultar el panel de depuraci√≥n al inicio, pero con la opci√≥n de abrirlo
        debugContentEl.classList.add('hidden');
        debugToggleIconEl.classList.add('rotate-180');
        appState.isDebugPanelVisible = false;
        
        // L√≥gica de carga de voz TTS
        if ('speechSynthesis' in window) {
            // Llamar inmediatamente y configurar el listener
            cacheSpanishVoice(); 
            window.speechSynthesis.onvoiceschanged = cacheSpanishVoice;
        }

        if (!SpeechRecognition) {
            statusMessage.textContent = 'ERROR: El reconocimiento de voz no est√° disponible en este dispositivo.';
            mainButton.disabled = true;
            setMainButtonState('listen');
            mainButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }
    };
</script>

</body>
</html>